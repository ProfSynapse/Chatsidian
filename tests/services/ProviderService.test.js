/**
 * Tests for the ProviderService.
 */
import { ProviderService } from '../../src/services/ProviderService';
import { SettingsService } from '../../src/services/SettingsService';
import { EventBus } from '../../src/core/EventBus';
import { ProviderFactory } from '../../src/providers/ProviderFactory';
// Mock the SettingsService
jest.mock('../../src/services/SettingsService', () => {
    return {
        SettingsService: jest.fn().mockImplementation(() => ({
            getSettingsManager: jest.fn().mockReturnValue({
                getSettings: jest.fn().mockReturnValue({
                    provider: 'openai',
                    apiKey: 'test-key',
                    apiEndpoint: 'https://api.test.com'
                })
            })
        }))
    };
});
// Mock the ProviderFactory
jest.mock('../../src/providers/ProviderFactory', () => {
    const mockAdapter = {
        provider: 'openai',
        testConnection: jest.fn().mockResolvedValue(true),
        getAvailableModels: jest.fn().mockResolvedValue([
            { id: 'gpt-4', name: 'GPT-4', provider: 'openai' }
        ]),
        sendRequest: jest.fn().mockResolvedValue({
            id: 'mock-id',
            message: { role: 'assistant', content: 'Hello world' }
        }),
        sendStreamingRequest: jest.fn().mockImplementation((request, onChunk) => {
            onChunk({
                id: 'mock-id',
                delta: { content: 'Hello world' }
            });
            return Promise.resolve();
        }),
        cancelRequest: jest.fn().mockResolvedValue(undefined)
    };
    return {
        ProviderFactory: {
            initialize: jest.fn().mockResolvedValue(undefined),
            createProvider: jest.fn().mockReturnValue(mockAdapter),
            getSupportedProviders: jest.fn().mockReturnValue(['openai', 'anthropic', 'google']),
            isProviderSupported: jest.fn().mockImplementation((provider) => {
                return ['openai', 'anthropic', 'google'].includes(provider);
            }),
            getModelsForProvider: jest.fn().mockImplementation((provider) => {
                return [{ id: 'gpt-4', name: 'GPT-4', provider: 'openai' }];
            }),
            getAllModels: jest.fn().mockReturnValue([
                { id: 'gpt-4', name: 'GPT-4', provider: 'openai' },
                { id: 'claude-3', name: 'Claude 3', provider: 'anthropic' }
            ]),
            findModelById: jest.fn().mockImplementation((modelId) => {
                if (modelId === 'gpt-4') {
                    return { id: 'gpt-4', name: 'GPT-4', provider: 'openai' };
                }
                return undefined;
            })
        }
    };
});
describe('ProviderService', () => {
    let providerService;
    let eventBus;
    let settingsService;
    beforeEach(() => {
        eventBus = new EventBus();
        settingsService = new SettingsService({}, {}, eventBus);
        // Initialize the provider service with the app
        providerService = new ProviderService({}, eventBus, settingsService);
        // Manually initialize the provider service
        providerService.initialize = jest.fn().mockResolvedValue(undefined);
        providerService.initialized = true;
    });
    test('should get provider adapter', async () => {
        const adapter = await providerService.getProvider('openai');
        expect(adapter).toBeDefined();
        expect(adapter.provider).toBe('openai');
        expect(ProviderFactory.createProvider).toHaveBeenCalledWith('openai', 'test-key', 'https://api.test.com');
    });
    test('should get provider adapter with custom API key', async () => {
        const adapter = await providerService.getProvider('openai', 'custom-key');
        expect(adapter).toBeDefined();
        expect(ProviderFactory.createProvider).toHaveBeenCalledWith('openai', 'custom-key', undefined);
    });
    test('should get provider adapter with custom API endpoint', async () => {
        const adapter = await providerService.getProvider('openai', 'custom-key', 'https://custom.api.com');
        expect(adapter).toBeDefined();
        expect(ProviderFactory.createProvider).toHaveBeenCalledWith('openai', 'custom-key', 'https://custom.api.com');
    });
    test('should test connection', async () => {
        const result = await providerService.testConnection('openai');
        expect(result).toBe(true);
    });
    test('should get available models', async () => {
        const models = await providerService.getAvailableModels('openai');
        expect(models).toHaveLength(1);
        expect(models[0].id).toBe('gpt-4');
    });
    test('should send request', async () => {
        const request = {
            model: 'gpt-4',
            messages: [{ role: 'user', content: 'Hello' }]
        };
        const response = await providerService.sendRequest('openai', request);
        expect(response.message.content).toBe('Hello world');
    });
    test('should send streaming request', async () => {
        const request = {
            model: 'gpt-4',
            messages: [{ role: 'user', content: 'Hello' }],
            stream: true
        };
        const chunks = [];
        await providerService.sendStreamingRequest('openai', request, (chunk) => {
            if (chunk.delta.content) {
                chunks.push(chunk.delta.content);
            }
        });
        expect(chunks.join('')).toBe('Hello world');
    });
    test('should cancel request', async () => {
        await providerService.cancelRequest('openai');
        // Just verify it doesn't throw
    });
    test('should get supported providers', () => {
        const providers = providerService.getSupportedProviders();
        expect(providers).toContain('openai');
        expect(providers).toContain('anthropic');
        expect(providers).toContain('google');
    });
    test('should check if provider is supported', () => {
        expect(providerService.isProviderSupported('openai')).toBe(true);
        expect(providerService.isProviderSupported('unsupported')).toBe(false);
    });
    test('should clear cache', () => {
        providerService.clearCache();
        // Just verify it doesn't throw
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvdmlkZXJTZXJ2aWNlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQcm92aWRlclNlcnZpY2UudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDckUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBR25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUl0RSwyQkFBMkI7QUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7SUFDbkQsT0FBTztRQUNMLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNuRCxrQkFBa0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUM1QyxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztvQkFDckMsUUFBUSxFQUFFLFFBQVE7b0JBQ2xCLE1BQU0sRUFBRSxVQUFVO29CQUNsQixXQUFXLEVBQUUsc0JBQXNCO2lCQUNwQyxDQUFDO2FBQ0gsQ0FBQztTQUNILENBQUMsQ0FBQztLQUNKLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILDJCQUEyQjtBQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtJQUNwRCxNQUFNLFdBQVcsR0FBRztRQUNsQixRQUFRLEVBQUUsUUFBUTtRQUNsQixjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQztRQUNqRCxrQkFBa0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJB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Q0FBQyxDQUFDO1FBQ3RDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7UUFDakQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqRSxNQUFNLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtRQUM5QixlQUFlLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDN0IsK0JBQStCO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogVGVzdHMgZm9yIHRoZSBQcm92aWRlclNlcnZpY2UuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgUHJvdmlkZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3JjL3NlcnZpY2VzL1Byb3ZpZGVyU2VydmljZSc7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2aWNlcy9TZXR0aW5nc1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBFdmVudEJ1cyB9IGZyb20gJy4uLy4uL3NyYy9jb3JlL0V2ZW50QnVzJztcclxuaW1wb3J0IHsgU2V0dGluZ3NNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vc3JjL2NvcmUvU2V0dGluZ3NNYW5hZ2VyJztcclxuaW1wb3J0IHsgQ2hhdHNpZGlhblNldHRpbmdzIH0gZnJvbSAnLi4vLi4vc3JjL21vZGVscy9TZXR0aW5ncyc7XHJcbmltcG9ydCB7IFByb3ZpZGVyRmFjdG9yeSB9IGZyb20gJy4uLy4uL3NyYy9wcm92aWRlcnMvUHJvdmlkZXJGYWN0b3J5JztcclxuaW1wb3J0IHsgUHJvdmlkZXJBZGFwdGVyIH0gZnJvbSAnLi4vLi4vc3JjL3Byb3ZpZGVycy9Qcm92aWRlckFkYXB0ZXInO1xyXG5pbXBvcnQgeyBQcm92aWRlclJlcXVlc3QgfSBmcm9tICcuLi8uLi9zcmMvbW9kZWxzL1Byb3ZpZGVyJztcclxuXHJcbi8vIE1vY2sgdGhlIFNldHRpbmdzU2VydmljZVxyXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9zZXJ2aWNlcy9TZXR0aW5nc1NlcnZpY2UnLCAoKSA9PiB7XHJcbiAgcmV0dXJuIHtcclxuICAgIFNldHRpbmdzU2VydmljZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xyXG4gICAgICBnZXRTZXR0aW5nc01hbmFnZXI6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGdldFNldHRpbmdzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHByb3ZpZGVyOiAnb3BlbmFpJyxcclxuICAgICAgICAgIGFwaUtleTogJ3Rlc3Qta2V5JyxcclxuICAgICAgICAgIGFwaUVuZHBvaW50OiAnaHR0cHM6Ly9hcGkudGVzdC5jb20nXHJcbiAgICAgICAgfSlcclxuICAgICAgfSlcclxuICAgIH0pKVxyXG4gIH07XHJcbn0pO1xyXG5cclxuLy8gTW9jayB0aGUgUHJvdmlkZXJGYWN0b3J5XHJcbmplc3QubW9jaygnLi4vLi4vc3JjL3Byb3ZpZGVycy9Qcm92aWRlckZhY3RvcnknLCAoKSA9PiB7XHJcbiAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XHJcbiAgICBwcm92aWRlcjogJ29wZW5haScsXHJcbiAgICB0ZXN0Q29ubmVjdGlvbjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHRydWUpLFxyXG4gICAgZ2V0QXZhaWxhYmxlTW9kZWxzOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW1xyXG4gICAgICB7IGlkOiAnZ3B0LTQnLCBuYW1lOiAnR1BULTQnLCBwcm92aWRlcjogJ29wZW5haScgfVxyXG4gICAgXSksXHJcbiAgICBzZW5kUmVxdWVzdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcclxuICAgICAgaWQ6ICdtb2NrLWlkJyxcclxuICAgICAgbWVzc2FnZTogeyByb2xlOiAnYXNzaXN0YW50JywgY29udGVudDogJ0hlbGxvIHdvcmxkJyB9XHJcbiAgICB9KSxcclxuICAgIHNlbmRTdHJlYW1pbmdSZXF1ZXN0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChyZXF1ZXN0LCBvbkNodW5rKSA9PiB7XHJcbiAgICAgIG9uQ2h1bmsoe1xyXG4gICAgICAgIGlkOiAnbW9jay1pZCcsXHJcbiAgICAgICAgZGVsdGE6IHsgY29udGVudDogJ0hlbGxvIHdvcmxkJyB9XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9KSxcclxuICAgIGNhbmNlbFJlcXVlc3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIFByb3ZpZGVyRmFjdG9yeToge1xyXG4gICAgICBpbml0aWFsaXplOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcclxuICAgICAgY3JlYXRlUHJvdmlkZXI6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobW9ja0FkYXB0ZXIpLFxyXG4gICAgICBnZXRTdXBwb3J0ZWRQcm92aWRlcnM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoWydvcGVuYWknLCAnYW50aHJvcGljJywgJ2dvb2dsZSddKSxcclxuICAgICAgaXNQcm92aWRlclN1cHBvcnRlZDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigocHJvdmlkZXIpID0+IHtcclxuICAgICAgICByZXR1cm4gWydvcGVuYWknLCAnYW50aHJvcGljJywgJ2dvb2dsZSddLmluY2x1ZGVzKHByb3ZpZGVyKTtcclxuICAgICAgfSksXHJcbiAgICAgIGdldE1vZGVsc0ZvclByb3ZpZGVyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChwcm92aWRlcikgPT4ge1xyXG4gICAgICAgIHJldHVybiBbeyBpZDogJ2dwdC00JywgbmFtZTogJ0dQVC00JywgcHJvdmlkZXI6ICdvcGVuYWknIH1dO1xyXG4gICAgICB9KSxcclxuICAgICAgZ2V0QWxsTW9kZWxzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFtcclxuICAgICAgICB7IGlkOiAnZ3B0LTQnLCBuYW1lOiAnR1BULTQnLCBwcm92aWRlcjogJ29wZW5haScgfSxcclxuICAgICAgICB7IGlkOiAnY2xhdWRlLTMnLCBuYW1lOiAnQ2xhdWRlIDMnLCBwcm92aWRlcjogJ2FudGhyb3BpYycgfVxyXG4gICAgICBdKSxcclxuICAgICAgZmluZE1vZGVsQnlJZDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigobW9kZWxJZCkgPT4ge1xyXG4gICAgICAgIGlmIChtb2RlbElkID09PSAnZ3B0LTQnKSB7XHJcbiAgICAgICAgICByZXR1cm4geyBpZDogJ2dwdC00JywgbmFtZTogJ0dQVC00JywgcHJvdmlkZXI6ICdvcGVuYWknIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgfTtcclxufSk7XHJcblxyXG5kZXNjcmliZSgnUHJvdmlkZXJTZXJ2aWNlJywgKCkgPT4ge1xyXG4gIGxldCBwcm92aWRlclNlcnZpY2U6IFByb3ZpZGVyU2VydmljZTtcclxuICBsZXQgZXZlbnRCdXM6IEV2ZW50QnVzO1xyXG4gIGxldCBzZXR0aW5nc1NlcnZpY2U6IFNldHRpbmdzU2VydmljZTtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBldmVudEJ1cyA9IG5ldyBFdmVudEJ1cygpO1xyXG4gICAgc2V0dGluZ3NTZXJ2aWNlID0gbmV3IFNldHRpbmdzU2VydmljZSh7fSBhcyBhbnksIHt9IGFzIGFueSwgZXZlbnRCdXMpO1xyXG4gICAgXHJcbiAgICAvLyBJbml0aWFsaXplIHRoZSBwcm92aWRlciBzZXJ2aWNlIHdpdGggdGhlIGFwcFxyXG4gICAgcHJvdmlkZXJTZXJ2aWNlID0gbmV3IFByb3ZpZGVyU2VydmljZSh7fSBhcyBhbnksIGV2ZW50QnVzLCBzZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgXHJcbiAgICAvLyBNYW51YWxseSBpbml0aWFsaXplIHRoZSBwcm92aWRlciBzZXJ2aWNlXHJcbiAgICBwcm92aWRlclNlcnZpY2UuaW5pdGlhbGl6ZSA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG4gICAgKHByb3ZpZGVyU2VydmljZSBhcyBhbnkpLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICB9KTtcclxuXHJcbiAgdGVzdCgnc2hvdWxkIGdldCBwcm92aWRlciBhZGFwdGVyJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgYWRhcHRlciA9IGF3YWl0IHByb3ZpZGVyU2VydmljZS5nZXRQcm92aWRlcignb3BlbmFpJyk7XHJcbiAgICBleHBlY3QoYWRhcHRlcikudG9CZURlZmluZWQoKTtcclxuICAgIGV4cGVjdChhZGFwdGVyLnByb3ZpZGVyKS50b0JlKCdvcGVuYWknKTtcclxuICAgIGV4cGVjdChQcm92aWRlckZhY3RvcnkuY3JlYXRlUHJvdmlkZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdvcGVuYWknLCAndGVzdC1rZXknLCAnaHR0cHM6Ly9hcGkudGVzdC5jb20nKTtcclxuICB9KTtcclxuXHJcbiAgdGVzdCgnc2hvdWxkIGdldCBwcm92aWRlciBhZGFwdGVyIHdpdGggY3VzdG9tIEFQSSBrZXknLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBhZGFwdGVyID0gYXdhaXQgcHJvdmlkZXJTZXJ2aWNlLmdldFByb3ZpZGVyKCdvcGVuYWknLCAnY3VzdG9tLWtleScpO1xyXG4gICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICBleHBlY3QoUHJvdmlkZXJGYWN0b3J5LmNyZWF0ZVByb3ZpZGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnb3BlbmFpJywgJ2N1c3RvbS1rZXknLCB1bmRlZmluZWQpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdzaG91bGQgZ2V0IHByb3ZpZGVyIGFkYXB0ZXIgd2l0aCBjdXN0b20gQVBJIGVuZHBvaW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgYWRhcHRlciA9IGF3YWl0IHByb3ZpZGVyU2VydmljZS5nZXRQcm92aWRlcignb3BlbmFpJywgJ2N1c3RvbS1rZXknLCAnaHR0cHM6Ly9jdXN0b20uYXBpLmNvbScpO1xyXG4gICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICBleHBlY3QoUHJvdmlkZXJGYWN0b3J5LmNyZWF0ZVByb3ZpZGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnb3BlbmFpJywgJ2N1c3RvbS1rZXknLCAnaHR0cHM6Ly9jdXN0b20uYXBpLmNvbScpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdzaG91bGQgdGVzdCBjb25uZWN0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvdmlkZXJTZXJ2aWNlLnRlc3RDb25uZWN0aW9uKCdvcGVuYWknKTtcclxuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoJ3Nob3VsZCBnZXQgYXZhaWxhYmxlIG1vZGVscycsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IG1vZGVscyA9IGF3YWl0IHByb3ZpZGVyU2VydmljZS5nZXRBdmFpbGFibGVNb2RlbHMoJ29wZW5haScpO1xyXG4gICAgZXhwZWN0KG1vZGVscykudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgZXhwZWN0KG1vZGVsc1swXS5pZCkudG9CZSgnZ3B0LTQnKTtcclxuICB9KTtcclxuXHJcbiAgdGVzdCgnc2hvdWxkIHNlbmQgcmVxdWVzdCcsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlcXVlc3Q6IFByb3ZpZGVyUmVxdWVzdCA9IHtcclxuICAgICAgbW9kZWw6ICdncHQtNCcsXHJcbiAgICAgIG1lc3NhZ2VzOiBbeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6ICdIZWxsbycgfV1cclxuICAgIH07XHJcbiAgICBcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcHJvdmlkZXJTZXJ2aWNlLnNlbmRSZXF1ZXN0KCdvcGVuYWknLCByZXF1ZXN0KTtcclxuICAgIGV4cGVjdChyZXNwb25zZS5tZXNzYWdlLmNvbnRlbnQpLnRvQmUoJ0hlbGxvIHdvcmxkJyk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoJ3Nob3VsZCBzZW5kIHN0cmVhbWluZyByZXF1ZXN0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgcmVxdWVzdDogUHJvdmlkZXJSZXF1ZXN0ID0ge1xyXG4gICAgICBtb2RlbDogJ2dwdC00JyxcclxuICAgICAgbWVzc2FnZXM6IFt7IHJvbGU6ICd1c2VyJywgY29udGVudDogJ0hlbGxvJyB9XSxcclxuICAgICAgc3RyZWFtOiB0cnVlXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBjb25zdCBjaHVua3M6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGF3YWl0IHByb3ZpZGVyU2VydmljZS5zZW5kU3RyZWFtaW5nUmVxdWVzdCgnb3BlbmFpJywgcmVxdWVzdCwgKGNodW5rKSA9PiB7XHJcbiAgICAgIGlmIChjaHVuay5kZWx0YS5jb250ZW50KSB7XHJcbiAgICAgICAgY2h1bmtzLnB1c2goY2h1bmsuZGVsdGEuY29udGVudCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBleHBlY3QoY2h1bmtzLmpvaW4oJycpKS50b0JlKCdIZWxsbyB3b3JsZCcpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdzaG91bGQgY2FuY2VsIHJlcXVlc3QnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBwcm92aWRlclNlcnZpY2UuY2FuY2VsUmVxdWVzdCgnb3BlbmFpJyk7XHJcbiAgICAvLyBKdXN0IHZlcmlmeSBpdCBkb2Vzbid0IHRocm93XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoJ3Nob3VsZCBnZXQgc3VwcG9ydGVkIHByb3ZpZGVycycsICgpID0+IHtcclxuICAgIGNvbnN0IHByb3ZpZGVycyA9IHByb3ZpZGVyU2VydmljZS5nZXRTdXBwb3J0ZWRQcm92aWRlcnMoKTtcclxuICAgIGV4cGVjdChwcm92aWRlcnMpLnRvQ29udGFpbignb3BlbmFpJyk7XHJcbiAgICBleHBlY3QocHJvdmlkZXJzKS50b0NvbnRhaW4oJ2FudGhyb3BpYycpO1xyXG4gICAgZXhwZWN0KHByb3ZpZGVycykudG9Db250YWluKCdnb29nbGUnKTtcclxuICB9KTtcclxuXHJcbiAgdGVzdCgnc2hvdWxkIGNoZWNrIGlmIHByb3ZpZGVyIGlzIHN1cHBvcnRlZCcsICgpID0+IHtcclxuICAgIGV4cGVjdChwcm92aWRlclNlcnZpY2UuaXNQcm92aWRlclN1cHBvcnRlZCgnb3BlbmFpJykpLnRvQmUodHJ1ZSk7XHJcbiAgICBleHBlY3QocHJvdmlkZXJTZXJ2aWNlLmlzUHJvdmlkZXJTdXBwb3J0ZWQoJ3Vuc3VwcG9ydGVkJykpLnRvQmUoZmFsc2UpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdzaG91bGQgY2xlYXIgY2FjaGUnLCAoKSA9PiB7XHJcbiAgICBwcm92aWRlclNlcnZpY2UuY2xlYXJDYWNoZSgpO1xyXG4gICAgLy8gSnVzdCB2ZXJpZnkgaXQgZG9lc24ndCB0aHJvd1xyXG4gIH0pO1xyXG59KTtcclxuIl19