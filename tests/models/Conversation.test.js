import { MessageRole, ConversationUtils, } from '../../src/models/Conversation';
// Mock TFile if needed for tests involving file/path properties
// jest.mock('obsidian', () => ({ TFile: jest.fn() }), { virtual: true });
describe('Conversation Model & Utils', () => {
    let baseConversation;
    let baseMessage;
    beforeEach(() => {
        // Reset base objects before each test
        baseConversation = {
            id: 'test-conv-id',
            title: 'Test Conversation',
            createdAt: 1619816400000, // Consistent timestamp for predictability
            modifiedAt: 1619816400000,
            messages: [],
            // Optional fields can be added if needed for specific tests
            // metadata: {},
            // file: new TFile(), // Requires mocking TFile
            // path: 'test/path/conversation.json'
        };
        baseMessage = {
            id: 'test-msg-id',
            role: MessageRole.User,
            content: 'Hello, test!',
            timestamp: 1619816400000,
            // Optional fields
            // toolCalls: [],
            // toolResults: []
        };
    });
    // --- Basic Interface Tests ---
    test('Conversation interface should accept valid properties', () => {
        const conversation = { ...baseConversation }; // Use spread to avoid mutation
        expect(conversation.id).toBe('test-conv-id');
        expect(conversation.title).toBe('Test Conversation');
        expect(conversation.messages).toEqual([]); // Check for empty array
    });
    test('Message interface should accept valid properties', () => {
        const message = { ...baseMessage };
        expect(message.id).toBe('test-msg-id');
        expect(message.role).toBe(MessageRole.User);
        expect(message.content).toBe('Hello, test!');
    });
    test('MessageRole enum should have correct values', () => {
        expect(MessageRole.User).toBe('user');
        expect(MessageRole.Assistant).toBe('assistant');
        expect(MessageRole.System).toBe('system');
    });
    // --- ConversationUtils Tests ---
    describe('ConversationUtils.createNew', () => {
        test('should generate a conversation with a unique ID', () => {
            const conversation1 = ConversationUtils.createNew();
            const conversation2 = ConversationUtils.createNew();
            expect(conversation1.id).toBeDefined();
            expect(conversation2.id).toBeDefined();
            expect(conversation1.id).not.toBe(conversation2.id);
        });
        test('should generate a conversation with default title containing date/time', () => {
            const conversation = ConversationUtils.createNew();
            // Check if title contains "New Conversation" and some date/time representation (e.g., year, slashes, colons)
            expect(conversation.title).toMatch(/New Conversation \(.+\)/);
            expect(conversation.title).toMatch(/\d{1,2}\/\d{1,2}\/\d{4}/); // Example date format check
        });
        test('should accept and use a custom title', () => {
            const customTitle = 'My Custom Chat';
            const conversation = ConversationUtils.createNew(customTitle);
            expect(conversation.title).toBe(customTitle);
        });
        test('should initialize with empty messages array', () => {
            const conversation = ConversationUtils.createNew();
            expect(conversation.messages).toEqual([]);
        });
        test('should set createdAt and modifiedAt timestamps', () => {
            const before = Date.now();
            const conversation = ConversationUtils.createNew();
            const after = Date.now();
            expect(conversation.createdAt).toBeGreaterThanOrEqual(before);
            expect(conversation.createdAt).toBeLessThanOrEqual(after);
            expect(conversation.modifiedAt).toEqual(conversation.createdAt);
        });
    });
    describe('ConversationUtils.createMessage', () => {
        test('should generate a message with a unique ID', () => {
            const message1 = ConversationUtils.createMessage(MessageRole.User, 'Msg 1');
            const message2 = ConversationUtils.createMessage(MessageRole.User, 'Msg 2');
            expect(message1.id).toBeDefined();
            expect(message2.id).toBeDefined();
            expect(message1.id).not.toBe(message2.id);
        });
        test('should set the correct role and content', () => {
            const role = MessageRole.Assistant;
            const content = 'This is assistant content.';
            const message = ConversationUtils.createMessage(role, content);
            expect(message.role).toBe(role);
            expect(message.content).toBe(content);
        });
        test('should set the timestamp', () => {
            const before = Date.now();
            const message = ConversationUtils.createMessage(MessageRole.User, 'Timestamp test');
            const after = Date.now();
            expect(message.timestamp).toBeGreaterThanOrEqual(before);
            expect(message.timestamp).toBeLessThanOrEqual(after);
        });
        test('should not include toolCalls or toolResults by default', () => {
            const message = ConversationUtils.createMessage(MessageRole.User, 'No tools');
            expect(message.toolCalls).toBeUndefined();
            expect(message.toolResults).toBeUndefined();
        });
    });
    describe('ConversationUtils.addMessage', () => {
        test('should return a new conversation object (immutability)', () => {
            const originalConversation = ConversationUtils.createNew();
            const message = ConversationUtils.createMessage(MessageRole.User, 'Immutable?');
            const updatedConversation = ConversationUtils.addMessage(originalConversation, message);
            expect(updatedConversation).not.toBe(originalConversation); // Check for different object reference
            expect(originalConversation.messages).toHaveLength(0); // Original should be unchanged
        });
        test('should add the message to the messages array', () => {
            const conversation = ConversationUtils.createNew();
            const message = ConversationUtils.createMessage(MessageRole.User, 'Add me');
            const updatedConversation = ConversationUtils.addMessage(conversation, message);
            expect(updatedConversation.messages).toHaveLength(1);
            expect(updatedConversation.messages[0]).toEqual(message); // Check if the correct message was added
        });
        test('should add multiple messages correctly', () => {
            let conversation = ConversationUtils.createNew();
            const message1 = ConversationUtils.createMessage(MessageRole.User, 'First');
            const message2 = ConversationUtils.createMessage(MessageRole.Assistant, 'Second');
            conversation = ConversationUtils.addMessage(conversation, message1);
            conversation = ConversationUtils.addMessage(conversation, message2);
            expect(conversation.messages).toHaveLength(2);
            expect(conversation.messages[0]).toEqual(message1);
            expect(conversation.messages[1]).toEqual(message2);
        });
        test('should update the modifiedAt timestamp', () => {
            const conversation = ConversationUtils.createNew();
            // Ensure a slight delay for timestamp comparison
            jest.advanceTimersByTime(10);
            const message = ConversationUtils.createMessage(MessageRole.User, 'Update time');
            const updatedConversation = ConversationUtils.addMessage(conversation, message);
            expect(updatedConversation.modifiedAt).toBeGreaterThan(conversation.createdAt);
            expect(updatedConversation.modifiedAt).toBeGreaterThanOrEqual(message.timestamp);
        });
    });
    // --- Edge Cases/Optional Fields ---
    test('Conversation can include optional fields', () => {
        const conversation = {
            ...baseConversation,
            metadata: { tag: 'test' },
            path: 'a/b/c.json'
        };
        expect(conversation.metadata).toEqual({ tag: 'test' });
        expect(conversation.path).toBe('a/b/c.json');
    });
    test('Message can include optional tool calls and results', () => {
        const toolCall = { id: 'tc1', name: 'tool', arguments: {}, status: 'pending' };
        const toolResult = { id: 'tr1', toolCallId: 'tc1', content: 'result' };
        const message = {
            ...baseMessage,
            toolCalls: [toolCall],
            toolResults: [toolResult]
        };
        expect(message.toolCalls).toEqual([toolCall]);
        expect(message.toolResults).toEqual([toolResult]);
    });
});
// Enable fake timers for timestamp tests if needed
beforeAll(() => {
    jest.useFakeTimers();
});
afterAll(() => {
    jest.useRealTimers();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udmVyc2F0aW9uLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDb252ZXJzYXRpb24udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBR0wsV0FBVyxFQUNYLGlCQUFpQixHQUNsQixNQUFNLCtCQUErQixDQUFDO0FBRXZDLGdFQUFnRTtBQUNoRSwwRUFBMEU7QUFFMUUsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLGdCQUE4QixDQUFDO0lBQ25DLElBQUksV0FBb0IsQ0FBQztJQUV6QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2Qsc0NBQXNDO1FBQ3RDLGdCQUFnQixHQUFHO1lBQ2pCLEVBQUUsRUFBRSxjQUFjO1lBQ2xCLEtBQUssRUFBRSxtQkFBbUI7WUFDMUIsU0FBUyxFQUFFLGFBQWEsRUFBRSwwQ0FBMEM7WUFDcEUsVUFBVSxFQUFFLGFBQWE7WUFDekIsUUFBUSxFQUFFLEVBQUU7WUFDWiw0REFBNEQ7WUFDNUQsZ0JBQWdCO1lBQ2hCLCtDQUErQztZQUMvQyxzQ0FBc0M7U0FDdkMsQ0FBQztRQUVGLFdBQVcsR0FBRztZQUNaLEVBQUUsRUFBRSxhQUFhO1lBQ2pCLElBQUksRUFBRSxXQUFXLENBQUMsSUFBSTtZQUN0QixPQUFPLEVBQUUsY0FBYztZQUN2QixTQUFTLEVBQUUsYUFBYTtZQUN4QixrQkFBa0I7WUFDbEIsaUJBQWlCO1lBQ2pCLGtCQUFrQjtTQUNuQixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxnQ0FBZ0M7SUFFaEMsSUFBSSxDQUFDLHVEQUF1RCxFQUFFLEdBQUcsRUFBRTtRQUNqRSxNQUFNLFlBQVksR0FBaUIsRUFBRSxHQUFHLGdCQUFnQixFQUFFLENBQUMsQ0FBQywrQkFBK0I7UUFDM0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0MsTUFBTSxDQUFDLFlBQVksQ0FBQyxL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QVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDOUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUMsQ0FBQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLENBQUM7QUFFSCxtREFBbUQ7QUFDbkQsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxHQUFHLEVBQUU7SUFDWixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbnZlcnNhdGlvbixcclxuICBNZXNzYWdlLFxyXG4gIE1lc3NhZ2VSb2xlLFxyXG4gIENvbnZlcnNhdGlvblV0aWxzLFxyXG59IGZyb20gJy4uLy4uL3NyYy9tb2RlbHMvQ29udmVyc2F0aW9uJztcclxuXHJcbi8vIE1vY2sgVEZpbGUgaWYgbmVlZGVkIGZvciB0ZXN0cyBpbnZvbHZpbmcgZmlsZS9wYXRoIHByb3BlcnRpZXNcclxuLy8gamVzdC5tb2NrKCdvYnNpZGlhbicsICgpID0+ICh7IFRGaWxlOiBqZXN0LmZuKCkgfSksIHsgdmlydHVhbDogdHJ1ZSB9KTtcclxuXHJcbmRlc2NyaWJlKCdDb252ZXJzYXRpb24gTW9kZWwgJiBVdGlscycsICgpID0+IHtcclxuICBsZXQgYmFzZUNvbnZlcnNhdGlvbjogQ29udmVyc2F0aW9uO1xyXG4gIGxldCBiYXNlTWVzc2FnZTogTWVzc2FnZTtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAvLyBSZXNldCBiYXNlIG9iamVjdHMgYmVmb3JlIGVhY2ggdGVzdFxyXG4gICAgYmFzZUNvbnZlcnNhdGlvbiA9IHtcclxuICAgICAgaWQ6ICd0ZXN0LWNvbnYtaWQnLFxyXG4gICAgICB0aXRsZTogJ1Rlc3QgQ29udmVyc2F0aW9uJyxcclxuICAgICAgY3JlYXRlZEF0OiAxNjE5ODE2NDAwMDAwLCAvLyBDb25zaXN0ZW50IHRpbWVzdGFtcCBmb3IgcHJlZGljdGFiaWxpdHlcclxuICAgICAgbW9kaWZpZWRBdDogMTYxOTgxNjQwMDAwMCxcclxuICAgICAgbWVzc2FnZXM6IFtdLFxyXG4gICAgICAvLyBPcHRpb25hbCBmaWVsZHMgY2FuIGJlIGFkZGVkIGlmIG5lZWRlZCBmb3Igc3BlY2lmaWMgdGVzdHNcclxuICAgICAgLy8gbWV0YWRhdGE6IHt9LFxyXG4gICAgICAvLyBmaWxlOiBuZXcgVEZpbGUoKSwgLy8gUmVxdWlyZXMgbW9ja2luZyBURmlsZVxyXG4gICAgICAvLyBwYXRoOiAndGVzdC9wYXRoL2NvbnZlcnNhdGlvbi5qc29uJ1xyXG4gICAgfTtcclxuXHJcbiAgICBiYXNlTWVzc2FnZSA9IHtcclxuICAgICAgaWQ6ICd0ZXN0LW1zZy1pZCcsXHJcbiAgICAgIHJvbGU6IE1lc3NhZ2VSb2xlLlVzZXIsXHJcbiAgICAgIGNvbnRlbnQ6ICdIZWxsbywgdGVzdCEnLFxyXG4gICAgICB0aW1lc3RhbXA6IDE2MTk4MTY0MDAwMDAsXHJcbiAgICAgIC8vIE9wdGlvbmFsIGZpZWxkc1xyXG4gICAgICAvLyB0b29sQ2FsbHM6IFtdLFxyXG4gICAgICAvLyB0b29sUmVzdWx0czogW11cclxuICAgIH07XHJcbiAgfSk7XHJcblxyXG4gIC8vIC0tLSBCYXNpYyBJbnRlcmZhY2UgVGVzdHMgLS0tXHJcblxyXG4gIHRlc3QoJ0NvbnZlcnNhdGlvbiBpbnRlcmZhY2Ugc2hvdWxkIGFjY2VwdCB2YWxpZCBwcm9wZXJ0aWVzJywgKCkgPT4ge1xyXG4gICAgY29uc3QgY29udmVyc2F0aW9uOiBDb252ZXJzYXRpb24gPSB7IC4uLmJhc2VDb252ZXJzYXRpb24gfTsgLy8gVXNlIHNwcmVhZCB0byBhdm9pZCBtdXRhdGlvblxyXG4gICAgZXhwZWN0KGNvbnZlcnNhdGlvbi5pZCkudG9CZSgndGVzdC1jb252LWlkJyk7XHJcbiAgICBleHBlY3QoY29udmVyc2F0aW9uLnRpdGxlKS50b0JlKCdUZXN0IENvbnZlcnNhdGlvbicpO1xyXG4gICAgZXhwZWN0KGNvbnZlcnNhdGlvbi5tZXNzYWdlcykudG9FcXVhbChbXSk7IC8vIENoZWNrIGZvciBlbXB0eSBhcnJheVxyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdNZXNzYWdlIGludGVyZmFjZSBzaG91bGQgYWNjZXB0IHZhbGlkIHByb3BlcnRpZXMnLCAoKSA9PiB7XHJcbiAgICBjb25zdCBtZXNzYWdlOiBNZXNzYWdlID0geyAuLi5iYXNlTWVzc2FnZSB9O1xyXG4gICAgZXhwZWN0KG1lc3NhZ2UuaWQpLnRvQmUoJ3Rlc3QtbXNnLWlkJyk7XHJcbiAgICBleHBlY3QobWVzc2FnZS5yb2xlKS50b0JlKE1lc3NhZ2VSb2xlLlVzZXIpO1xyXG4gICAgZXhwZWN0KG1lc3NhZ2UuY29udGVudCkudG9CZSgnSGVsbG8sIHRlc3QhJyk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoJ01lc3NhZ2VSb2xlIGVudW0gc2hvdWxkIGhhdmUgY29ycmVjdCB2YWx1ZXMnLCAoKSA9PiB7XHJcbiAgICBleHBlY3QoTWVzc2FnZVJvbGUuVXNlcikudG9CZSgndXNlcicpO1xyXG4gICAgZXhwZWN0KE1lc3NhZ2VSb2xlLkFzc2lzdGFudCkudG9CZSgnYXNzaXN0YW50Jyk7XHJcbiAgICBleHBlY3QoTWVzc2FnZVJvbGUuU3lzdGVtKS50b0JlKCdzeXN0ZW0nKTtcclxuICB9KTtcclxuXHJcbiAgLy8gLS0tIENvbnZlcnNhdGlvblV0aWxzIFRlc3RzIC0tLVxyXG5cclxuICBkZXNjcmliZSgnQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTmV3JywgKCkgPT4ge1xyXG4gICAgdGVzdCgnc2hvdWxkIGdlbmVyYXRlIGEgY29udmVyc2F0aW9uIHdpdGggYSB1bmlxdWUgSUQnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbjEgPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVOZXcoKTtcclxuICAgICAgY29uc3QgY29udmVyc2F0aW9uMiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICBleHBlY3QoY29udmVyc2F0aW9uMS5pZCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGNvbnZlcnNhdGlvbjIuaWQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24xLmlkKS5ub3QudG9CZShjb252ZXJzYXRpb24yLmlkKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBnZW5lcmF0ZSBhIGNvbnZlcnNhdGlvbiB3aXRoIGRlZmF1bHQgdGl0bGUgY29udGFpbmluZyBkYXRlL3RpbWUnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICAvLyBDaGVjayBpZiB0aXRsZSBjb250YWlucyBcIk5ldyBDb252ZXJzYXRpb25cIiBhbmQgc29tZSBkYXRlL3RpbWUgcmVwcmVzZW50YXRpb24gKGUuZy4sIHllYXIsIHNsYXNoZXMsIGNvbG9ucylcclxuICAgICAgZXhwZWN0KGNvbnZlcnNhdGlvbi50aXRsZSkudG9NYXRjaCgvTmV3IENvbnZlcnNhdGlvbiBcXCguK1xcKS8pO1xyXG4gICAgICBleHBlY3QoY29udmVyc2F0aW9uLnRpdGxlKS50b01hdGNoKC9cXGR7MSwyfVxcL1xcZHsxLDJ9XFwvXFxkezR9Lyk7IC8vIEV4YW1wbGUgZGF0ZSBmb3JtYXQgY2hlY2tcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBhY2NlcHQgYW5kIHVzZSBhIGN1c3RvbSB0aXRsZScsICgpID0+IHtcclxuICAgICAgY29uc3QgY3VzdG9tVGl0bGUgPSAnTXkgQ3VzdG9tIENoYXQnO1xyXG4gICAgICBjb25zdCBjb252ZXJzYXRpb24gPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVOZXcoY3VzdG9tVGl0bGUpO1xyXG4gICAgICBleHBlY3QoY29udmVyc2F0aW9uLnRpdGxlKS50b0JlKGN1c3RvbVRpdGxlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBpbml0aWFsaXplIHdpdGggZW1wdHkgbWVzc2FnZXMgYXJyYXknLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICBleHBlY3QoY29udmVyc2F0aW9uLm1lc3NhZ2VzKS50b0VxdWFsKFtdKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBzZXQgY3JlYXRlZEF0IGFuZCBtb2RpZmllZEF0IHRpbWVzdGFtcHMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGJlZm9yZSA9IERhdGUubm93KCk7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICBjb25zdCBhZnRlciA9IERhdGUubm93KCk7XHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24uY3JlYXRlZEF0KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKGJlZm9yZSk7XHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24uY3JlYXRlZEF0KS50b0JlTGVzc1RoYW5PckVxdWFsKGFmdGVyKTtcclxuICAgICAgZXhwZWN0KGNvbnZlcnNhdGlvbi5tb2RpZmllZEF0KS50b0VxdWFsKGNvbnZlcnNhdGlvbi5jcmVhdGVkQXQpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdDb252ZXJzYXRpb25VdGlscy5jcmVhdGVNZXNzYWdlJywgKCkgPT4ge1xyXG4gICAgdGVzdCgnc2hvdWxkIGdlbmVyYXRlIGEgbWVzc2FnZSB3aXRoIGEgdW5pcXVlIElEJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtZXNzYWdlMSA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU1lc3NhZ2UoTWVzc2FnZVJvbGUuVXNlciwgJ01zZyAxJyk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UyID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTWVzc2FnZShNZXNzYWdlUm9sZS5Vc2VyLCAnTXNnIDInKTtcclxuICAgICAgZXhwZWN0KG1lc3NhZ2UxLmlkKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QobWVzc2FnZTIuaWQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChtZXNzYWdlMS5pZCkubm90LnRvQmUobWVzc2FnZTIuaWQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIHNldCB0aGUgY29ycmVjdCByb2xlIGFuZCBjb250ZW50JywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByb2xlID0gTWVzc2FnZVJvbGUuQXNzaXN0YW50O1xyXG4gICAgICBjb25zdCBjb250ZW50ID0gJ1RoaXMgaXMgYXNzaXN0YW50IGNvbnRlbnQuJztcclxuICAgICAgY29uc3QgbWVzc2FnZSA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU1lc3NhZ2Uocm9sZSwgY29udGVudCk7XHJcbiAgICAgIGV4cGVjdChtZXNzYWdlLnJvbGUpLnRvQmUocm9sZSk7XHJcbiAgICAgIGV4cGVjdChtZXNzYWdlLmNvbnRlbnQpLnRvQmUoY29udGVudCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXN0KCdzaG91bGQgc2V0IHRoZSB0aW1lc3RhbXAnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGJlZm9yZSA9IERhdGUubm93KCk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVNZXNzYWdlKE1lc3NhZ2VSb2xlLlVzZXIsICdUaW1lc3RhbXAgdGVzdCcpO1xyXG4gICAgICBjb25zdCBhZnRlciA9IERhdGUubm93KCk7XHJcbiAgICAgIGV4cGVjdChtZXNzYWdlLnRpbWVzdGFtcCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbChiZWZvcmUpO1xyXG4gICAgICBleHBlY3QobWVzc2FnZS50aW1lc3RhbXApLnRvQmVMZXNzVGhhbk9yRXF1YWwoYWZ0ZXIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIG5vdCBpbmNsdWRlIHRvb2xDYWxscyBvciB0b29sUmVzdWx0cyBieSBkZWZhdWx0JywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtZXNzYWdlID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTWVzc2FnZShNZXNzYWdlUm9sZS5Vc2VyLCAnTm8gdG9vbHMnKTtcclxuICAgICAgZXhwZWN0KG1lc3NhZ2UudG9vbENhbGxzKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChtZXNzYWdlLnRvb2xSZXN1bHRzKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NvbnZlcnNhdGlvblV0aWxzLmFkZE1lc3NhZ2UnLCAoKSA9PiB7XHJcbiAgICB0ZXN0KCdzaG91bGQgcmV0dXJuIGEgbmV3IGNvbnZlcnNhdGlvbiBvYmplY3QgKGltbXV0YWJpbGl0eSknLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ29udmVyc2F0aW9uID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTmV3KCk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVNZXNzYWdlKE1lc3NhZ2VSb2xlLlVzZXIsICdJbW11dGFibGU/Jyk7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRDb252ZXJzYXRpb24gPSBDb252ZXJzYXRpb25VdGlscy5hZGRNZXNzYWdlKG9yaWdpbmFsQ29udmVyc2F0aW9uLCBtZXNzYWdlKTtcclxuXHJcbiAgICAgIGV4cGVjdCh1cGRhdGVkQ29udmVyc2F0aW9uKS5ub3QudG9CZShvcmlnaW5hbENvbnZlcnNhdGlvbik7IC8vIENoZWNrIGZvciBkaWZmZXJlbnQgb2JqZWN0IHJlZmVyZW5jZVxyXG4gICAgICBleHBlY3Qob3JpZ2luYWxDb252ZXJzYXRpb24ubWVzc2FnZXMpLnRvSGF2ZUxlbmd0aCgwKTsgLy8gT3JpZ2luYWwgc2hvdWxkIGJlIHVuY2hhbmdlZFxyXG4gICAgfSk7XHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIGFkZCB0aGUgbWVzc2FnZSB0byB0aGUgbWVzc2FnZXMgYXJyYXknLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICBjb25zdCBtZXNzYWdlID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTWVzc2FnZShNZXNzYWdlUm9sZS5Vc2VyLCAnQWRkIG1lJyk7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRDb252ZXJzYXRpb24gPSBDb252ZXJzYXRpb25VdGlscy5hZGRNZXNzYWdlKGNvbnZlcnNhdGlvbiwgbWVzc2FnZSk7XHJcblxyXG4gICAgICBleHBlY3QodXBkYXRlZENvbnZlcnNhdGlvbi5tZXNzYWdlcykudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICBleHBlY3QodXBkYXRlZENvbnZlcnNhdGlvbi5tZXNzYWdlc1swXSkudG9FcXVhbChtZXNzYWdlKTsgLy8gQ2hlY2sgaWYgdGhlIGNvcnJlY3QgbWVzc2FnZSB3YXMgYWRkZWRcclxuICAgIH0pO1xyXG5cclxuICAgIHRlc3QoJ3Nob3VsZCBhZGQgbXVsdGlwbGUgbWVzc2FnZXMgY29ycmVjdGx5JywgKCkgPT4ge1xyXG4gICAgICBsZXQgY29udmVyc2F0aW9uID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTmV3KCk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UxID0gQ29udmVyc2F0aW9uVXRpbHMuY3JlYXRlTWVzc2FnZShNZXNzYWdlUm9sZS5Vc2VyLCAnRmlyc3QnKTtcclxuICAgICAgY29uc3QgbWVzc2FnZTIgPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVNZXNzYWdlKE1lc3NhZ2VSb2xlLkFzc2lzdGFudCwgJ1NlY29uZCcpO1xyXG5cclxuICAgICAgY29udmVyc2F0aW9uID0gQ29udmVyc2F0aW9uVXRpbHMuYWRkTWVzc2FnZShjb252ZXJzYXRpb24sIG1lc3NhZ2UxKTtcclxuICAgICAgY29udmVyc2F0aW9uID0gQ29udmVyc2F0aW9uVXRpbHMuYWRkTWVzc2FnZShjb252ZXJzYXRpb24sIG1lc3NhZ2UyKTtcclxuXHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24ubWVzc2FnZXMpLnRvSGF2ZUxlbmd0aCgyKTtcclxuICAgICAgZXhwZWN0KGNvbnZlcnNhdGlvbi5tZXNzYWdlc1swXSkudG9FcXVhbChtZXNzYWdlMSk7XHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24ubWVzc2FnZXNbMV0pLnRvRXF1YWwobWVzc2FnZTIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGVzdCgnc2hvdWxkIHVwZGF0ZSB0aGUgbW9kaWZpZWRBdCB0aW1lc3RhbXAnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IENvbnZlcnNhdGlvblV0aWxzLmNyZWF0ZU5ldygpO1xyXG4gICAgICAvLyBFbnN1cmUgYSBzbGlnaHQgZGVsYXkgZm9yIHRpbWVzdGFtcCBjb21wYXJpc29uXHJcbiAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSgxMCk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBDb252ZXJzYXRpb25VdGlscy5jcmVhdGVNZXNzYWdlKE1lc3NhZ2VSb2xlLlVzZXIsICdVcGRhdGUgdGltZScpO1xyXG4gICAgICBjb25zdCB1cGRhdGVkQ29udmVyc2F0aW9uID0gQ29udmVyc2F0aW9uVXRpbHMuYWRkTWVzc2FnZShjb252ZXJzYXRpb24sIG1lc3NhZ2UpO1xyXG5cclxuICAgICAgZXhwZWN0KHVwZGF0ZWRDb252ZXJzYXRpb24ubW9kaWZpZWRBdCkudG9CZUdyZWF0ZXJUaGFuKGNvbnZlcnNhdGlvbi5jcmVhdGVkQXQpO1xyXG4gICAgICBleHBlY3QodXBkYXRlZENvbnZlcnNhdGlvbi5tb2RpZmllZEF0KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKG1lc3NhZ2UudGltZXN0YW1wKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICAvLyAtLS0gRWRnZSBDYXNlcy9PcHRpb25hbCBGaWVsZHMgLS0tXHJcbiAgdGVzdCgnQ29udmVyc2F0aW9uIGNhbiBpbmNsdWRlIG9wdGlvbmFsIGZpZWxkcycsICgpID0+IHtcclxuICAgICAgY29uc3QgY29udmVyc2F0aW9uOiBDb252ZXJzYXRpb24gPSB7XHJcbiAgICAgICAgICAuLi5iYXNlQ29udmVyc2F0aW9uLFxyXG4gICAgICAgICAgbWV0YWRhdGE6IHsgdGFnOiAndGVzdCcgfSxcclxuICAgICAgICAgIHBhdGg6ICdhL2IvYy5qc29uJ1xyXG4gICAgICB9O1xyXG4gICAgICBleHBlY3QoY29udmVyc2F0aW9uLm1ldGFkYXRhKS50b0VxdWFsKHsgdGFnOiAndGVzdCcgfSk7XHJcbiAgICAgIGV4cGVjdChjb252ZXJzYXRpb24ucGF0aCkudG9CZSgnYS9iL2MuanNvbicpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KCdNZXNzYWdlIGNhbiBpbmNsdWRlIG9wdGlvbmFsIHRvb2wgY2FsbHMgYW5kIHJlc3VsdHMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRvb2xDYWxsOiBhbnkgPSB7IGlkOiAndGMxJywgbmFtZTogJ3Rvb2wnLCBhcmd1bWVudHM6IHt9LCBzdGF0dXM6ICdwZW5kaW5nJyB9O1xyXG4gICAgICBjb25zdCB0b29sUmVzdWx0OiBhbnkgPSB7IGlkOiAndHIxJywgdG9vbENhbGxJZDogJ3RjMScsIGNvbnRlbnQ6ICdyZXN1bHQnIH07XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IE1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAuLi5iYXNlTWVzc2FnZSxcclxuICAgICAgICAgIHRvb2xDYWxsczogW3Rvb2xDYWxsXSxcclxuICAgICAgICAgIHRvb2xSZXN1bHRzOiBbdG9vbFJlc3VsdF1cclxuICAgICAgfTtcclxuICAgICAgZXhwZWN0KG1lc3NhZ2UudG9vbENhbGxzKS50b0VxdWFsKFt0b29sQ2FsbF0pO1xyXG4gICAgICBleHBlY3QobWVzc2FnZS50b29sUmVzdWx0cykudG9FcXVhbChbdG9vbFJlc3VsdF0pO1xyXG4gIH0pO1xyXG5cclxufSk7XHJcblxyXG4vLyBFbmFibGUgZmFrZSB0aW1lcnMgZm9yIHRpbWVzdGFtcCB0ZXN0cyBpZiBuZWVkZWRcclxuYmVmb3JlQWxsKCgpID0+IHtcclxuICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcclxufSk7XHJcblxyXG5hZnRlckFsbCgoKSA9PiB7XHJcbiAgamVzdC51c2VSZWFsVGltZXJzKCk7XHJcbn0pO1xyXG4iXX0=