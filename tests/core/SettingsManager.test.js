import { SettingsManager, SettingsExportImport } from '../../src/core/SettingsManager';
import { DEFAULT_SETTINGS } from '../../src/models/Settings';
import { EventBus } from '../../src/core/EventBus';
describe('SettingsManager', () => {
    let eventBus;
    let saveSettings;
    let settingsManager;
    beforeEach(() => {
        eventBus = new EventBus();
        saveSettings = jest.fn().mockResolvedValue(undefined);
        settingsManager = new SettingsManager({ ...DEFAULT_SETTINGS }, saveSettings, eventBus);
    });
    test('should initialize with default settings', () => {
        const settings = settingsManager.getSettings();
        expect(settings).toEqual(DEFAULT_SETTINGS);
    });
    test('should initialize with custom settings', () => {
        const customSettings = {
            ...DEFAULT_SETTINGS,
            apiKey: 'test-key',
            model: 'test-model'
        };
        const manager = new SettingsManager(customSettings, saveSettings, eventBus);
        const settings = manager.getSettings();
        expect(settings.apiKey).toBe('test-key');
        expect(settings.model).toBe('test-model');
    });
    test('should update settings', async () => {
        const settingsHandler = jest.fn();
        eventBus.on('settings:updated', settingsHandler);
        await settingsManager.updateSettings({
            apiKey: 'new-key',
            model: 'new-model'
        });
        // Check settings were updated
        const settings = settingsManager.getSettings();
        expect(settings.apiKey).toBe('new-key');
        expect(settings.model).toBe('new-model');
        // Check save was called
        expect(saveSettings).toHaveBeenCalledWith(expect.objectContaining({
            apiKey: 'new-key',
            model: 'new-model'
        }));
        // Check event was emitted
        expect(settingsHandler).toHaveBeenCalledWith(expect.objectContaining({
            previousSettings: expect.any(Object),
            currentSettings: expect.any(Object),
            changedKeys: expect.arrayContaining(['apiKey', 'model'])
        }));
    });
    test('should set API key', async () => {
        await settingsManager.setApiKey('new-key');
        const settings = settingsManager.getSettings();
        expect(settings.apiKey).toBe('new-key');
        expect(saveSettings).toHaveBeenCalled();
    });
    test('should get provider', () => {
        expect(settingsManager.getProvider()).toBe(DEFAULT_SETTINGS.provider);
    });
    test('should get API key', () => {
        expect(settingsManager.getApiKey()).toBe(DEFAULT_SETTINGS.apiKey);
    });
    test('should get model', () => {
        expect(settingsManager.getModel()).toBe(DEFAULT_SETTINGS.model);
    });
    test('should get conversations path', () => {
        expect(settingsManager.getConversationsPath()).toBe(DEFAULT_SETTINGS.conversationsFolder);
    });
    test('should get default system prompt', () => {
        expect(settingsManager.getDefaultSystemPrompt()).toBe(DEFAULT_SETTINGS.defaultSystemPrompt);
    });
    test('should check if debug mode is enabled', () => {
        expect(settingsManager.isDebugModeEnabled()).toBe(DEFAULT_SETTINGS.debugMode);
    });
    test('should reset to defaults', async () => {
        // First update some settings
        await settingsManager.updateSettings({
            apiKey: 'test-key',
            model: 'test-model'
        });
        // Then reset to defaults
        await settingsManager.resetToDefaults();
        const settings = settingsManager.getSettings();
        expect(settings).toEqual(DEFAULT_SETTINGS);
    });
});
describe('SettingsExportImport', () => {
    let eventBus;
    let saveSettings;
    let settingsManager;
    let exportImport;
    beforeEach(() => {
        eventBus = new EventBus();
        saveSettings = jest.fn().mockResolvedValue(undefined);
        settingsManager = new SettingsManager({ ...DEFAULT_SETTINGS, apiKey: 'test-key' }, saveSettings, eventBus);
        exportImport = new SettingsExportImport(settingsManager);
    });
    test('should export settings to JSON without API key', () => {
        const json = exportImport.exportToJson(false);
        const exported = JSON.parse(json);
        expect(exported).toEqual(expect.objectContaining({
            ...DEFAULT_SETTINGS,
            apiKey: '' // API key should be removed
        }));
    });
    test('should export settings to JSON with API key', () => {
        const json = exportImport.exportToJson(true);
        const exported = JSON.parse(json);
        expect(exported).toEqual(expect.objectContaining({
            ...DEFAULT_SETTINGS,
            apiKey: 'test-key' // API key should be included
        }));
    });
    test('should import settings from JSON', async () => {
        const importJson = JSON.stringify({
            provider: 'openai',
            model: 'gpt-4',
            debugMode: true
        });
        await exportImport.importFromJson(importJson);
        const settings = settingsManager.getSettings();
        expect(settings.provider).toBe('openai');
        expect(settings.model).toBe('gpt-4');
        expect(settings.debugMode).toBe(true);
    });
    test('should throw error on invalid JSON', async () => {
        await expect(exportImport.importFromJson('invalid json')).rejects.toThrow();
    });
    test('should throw error on invalid settings format', async () => {
        await expect(exportImport.importFromJson('"not an object"')).rejects.toThrow();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2V0dGluZ3NNYW5hZ2VyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTZXR0aW5nc01hbmFnZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDdkYsT0FBTyxFQUFzQixnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVuRCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksUUFBa0IsQ0FBQztJQUN2QixJQUFJLFlBQXVCLENBQUM7SUFDNUIsSUFBSSxlQUFnQyxDQUFDO0lBRXJDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUMxQixZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RELGVBQWUsR0FBRyxJQUFJLGVBQWUsQ0FDbkMsRUFBRSxHQUFHLGdCQUFnQixFQUFFLEVBQ3ZCLFlBQVksRUFDWixRQUFRLENBQ1QsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtRQUNuRCxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFL0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHdDQUF3QyxFQUFFLEdBQUcsRUFBRTtRQUNsRCxNQUFNLGNBQWMsR0FBRztZQUNyQixHQUFHLGdCQUFnQjtZQUNuQixNQUFNLEVBQUUsVUFBVTtZQUNsQixLQUFLLEVBQUUsWUFBWTtTQUNwQixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxlQUFlLENBQ2pDLGNBQWMsRUFDZCxZQUFZLEVBQ1osUUFBUSxDQUNULENBQUM7UUFFRixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdkMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDeEMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2xDLFFBQVEsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFakQsTUFBTSxlQUFlLENBQUMsY0FBYyxDQUFDO1lBQ25DLE1BQU0sRUFBRSxTQUFTO1lBQ2pCLEtBQUssRUFBRSxXQUFXO1NBQ25CLENBQUMsQ0FBQztRQUVILDhCQUE4QjtRQUM5QixNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDL0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDeEMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFekMsd0JBQXdCO1FBQ3hCLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDaEUsTUFBTSxFQUFFLFNBQVM7WUFDakIsS0FBSyxFQUFFLFdBQVc7U0FDbkIsQ0FBQyxDQUFDLENBQUM7UUFFSiwwQkFBMEI7UUFDMUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztZQUNuRSxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUNwQyxlQUFlLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7WUFDbkMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDekQsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNwQyxNQUFNLGVBQWUsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFM0MsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUMvQixNQUFNLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtRQUM5QixNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3BFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtRQUM1QixNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtRQUN6QyxNQUFNLENBQUMsZUFBZSxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUM1RixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxrQ0FBa0MsRUFBRSxHQUFHLEVBQUU7UUFDNUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDOUYsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsdUNBQXVDLEVBQUUsR0FBRyxFQUFFO1FBQ2pELE1BQU0sQ0FBQyxlQUFlLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNoRixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQywwQkFBMEIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMxQyw2QkFBNkI7UUFDN0IsTUFBTSxlQUFlLENBQUMsY0FBYyxDQUFDO1lBQ25DLE1BQU0sRUFBRSxVQUFVO1lBQ2xCLEtBQUssRUFBRSxZQUFZO1NBQ3BCLENBQUMsQ0FBQztRQUVILHlCQUF5QjtRQUN6QixNQUFNLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV4QyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDL0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksUUFBa0IsQ0FBQztJQUN2QixJQUFJLFlBQXVCLENBQUM7SUFDNUIsSUFBSSxlQUFnQyxDQUFDO0lBQ3JDLElBQUksWUFBa0MsQ0FBQztJQUV2QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsUUFBUSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7UUFDMUIsWUFBWSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0RCxlQUFlLEdBQUcsSUFBSSxlQUFlLENBQ25DLEVBQUUsR0FBRyxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQzNDLFlBQVksRUFDWixRQUFRLENBQ1QsQ0FBQztRQUNGLFlBQVksR0FBRyxJQUFJLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzNELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGdEQUFnRCxFQUFFLEdBQUcsRUFBRTtRQUMxRCxNQUFNLElBQUksR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbEMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDL0MsR0FBRyxnQkFBZ0I7WUFDbkIsTUFBTSxFQUFFLEVBQUUsQ0FBQyw0QkFBNEI7U0FDeEMsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7UUFDdkQsTUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQy9DLEdBQUcsZ0JBQWdCO1lBQ25CLE1BQU0sRUFBRSxVQUFVLENBQUMsNkJBQTZCO1NBQ2pELENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDbEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNoQyxRQUFRLEVBQUUsUUFBUTtZQUNsQixLQUFLLEVBQUUsT0FBTztZQUNkLFNBQVMsRUFBRSxJQUFJO1NBQ2hCLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU5QyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDL0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDcEQsTUFBTSxNQUFNLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM5RSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQywrQ0FBK0MsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMvRCxNQUFNLE1BQU0sQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakYsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNldHRpbmdzTWFuYWdlciwgU2V0dGluZ3NFeHBvcnRJbXBvcnQgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9TZXR0aW5nc01hbmFnZXInO1xyXG5pbXBvcnQgeyBDaGF0c2lkaWFuU2V0dGluZ3MsIERFRkFVTFRfU0VUVElOR1MgfSBmcm9tICcuLi8uLi9zcmMvbW9kZWxzL1NldHRpbmdzJztcclxuaW1wb3J0IHsgRXZlbnRCdXMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9FdmVudEJ1cyc7XHJcblxyXG5kZXNjcmliZSgnU2V0dGluZ3NNYW5hZ2VyJywgKCkgPT4ge1xyXG4gIGxldCBldmVudEJ1czogRXZlbnRCdXM7XHJcbiAgbGV0IHNhdmVTZXR0aW5nczogamVzdC5Nb2NrO1xyXG4gIGxldCBzZXR0aW5nc01hbmFnZXI6IFNldHRpbmdzTWFuYWdlcjtcclxuICBcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGV2ZW50QnVzID0gbmV3IEV2ZW50QnVzKCk7XHJcbiAgICBzYXZlU2V0dGluZ3MgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuICAgIHNldHRpbmdzTWFuYWdlciA9IG5ldyBTZXR0aW5nc01hbmFnZXIoXHJcbiAgICAgIHsgLi4uREVGQVVMVF9TRVRUSU5HUyB9LFxyXG4gICAgICBzYXZlU2V0dGluZ3MsXHJcbiAgICAgIGV2ZW50QnVzXHJcbiAgICApO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBpbml0aWFsaXplIHdpdGggZGVmYXVsdCBzZXR0aW5ncycsICgpID0+IHtcclxuICAgIGNvbnN0IHNldHRpbmdzID0gc2V0dGluZ3NNYW5hZ2VyLmdldFNldHRpbmdzKCk7XHJcbiAgICBcclxuICAgIGV4cGVjdChzZXR0aW5ncykudG9FcXVhbChERUZBVUxUX1NFVFRJTkdTKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgaW5pdGlhbGl6ZSB3aXRoIGN1c3RvbSBzZXR0aW5ncycsICgpID0+IHtcclxuICAgIGNvbnN0IGN1c3RvbVNldHRpbmdzID0ge1xyXG4gICAgICAuLi5ERUZBVUxUX1NFVFRJTkdTLFxyXG4gICAgICBhcGlLZXk6ICd0ZXN0LWtleScsXHJcbiAgICAgIG1vZGVsOiAndGVzdC1tb2RlbCdcclxuICAgIH07XHJcbiAgICBcclxuICAgIGNvbnN0IG1hbmFnZXIgPSBuZXcgU2V0dGluZ3NNYW5hZ2VyKFxyXG4gICAgICBjdXN0b21TZXR0aW5ncyxcclxuICAgICAgc2F2ZVNldHRpbmdzLFxyXG4gICAgICBldmVudEJ1c1xyXG4gICAgKTtcclxuICAgIFxyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBtYW5hZ2VyLmdldFNldHRpbmdzKCk7XHJcbiAgICBcclxuICAgIGV4cGVjdChzZXR0aW5ncy5hcGlLZXkpLnRvQmUoJ3Rlc3Qta2V5Jyk7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3MubW9kZWwpLnRvQmUoJ3Rlc3QtbW9kZWwnKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgdXBkYXRlIHNldHRpbmdzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3Qgc2V0dGluZ3NIYW5kbGVyID0gamVzdC5mbigpO1xyXG4gICAgZXZlbnRCdXMub24oJ3NldHRpbmdzOnVwZGF0ZWQnLCBzZXR0aW5nc0hhbmRsZXIpO1xyXG4gICAgXHJcbiAgICBhd2FpdCBzZXR0aW5nc01hbmFnZXIudXBkYXRlU2V0dGluZ3Moe1xyXG4gICAgICBhcGlLZXk6ICduZXcta2V5JyxcclxuICAgICAgbW9kZWw6ICduZXctbW9kZWwnXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgLy8gQ2hlY2sgc2V0dGluZ3Mgd2VyZSB1cGRhdGVkXHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IHNldHRpbmdzTWFuYWdlci5nZXRTZXR0aW5ncygpO1xyXG4gICAgZXhwZWN0KHNldHRpbmdzLmFwaUtleSkudG9CZSgnbmV3LWtleScpO1xyXG4gICAgZXhwZWN0KHNldHRpbmdzLm1vZGVsKS50b0JlKCduZXctbW9kZWwnKTtcclxuICAgIFxyXG4gICAgLy8gQ2hlY2sgc2F2ZSB3YXMgY2FsbGVkXHJcbiAgICBleHBlY3Qoc2F2ZVNldHRpbmdzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgIGFwaUtleTogJ25ldy1rZXknLFxyXG4gICAgICBtb2RlbDogJ25ldy1tb2RlbCdcclxuICAgIH0pKTtcclxuICAgIFxyXG4gICAgLy8gQ2hlY2sgZXZlbnQgd2FzIGVtaXR0ZWRcclxuICAgIGV4cGVjdChzZXR0aW5nc0hhbmRsZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgcHJldmlvdXNTZXR0aW5nczogZXhwZWN0LmFueShPYmplY3QpLFxyXG4gICAgICBjdXJyZW50U2V0dGluZ3M6IGV4cGVjdC5hbnkoT2JqZWN0KSxcclxuICAgICAgY2hhbmdlZEtleXM6IGV4cGVjdC5hcnJheUNvbnRhaW5pbmcoWydhcGlLZXknLCAnbW9kZWwnXSlcclxuICAgIH0pKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgc2V0IEFQSSBrZXknLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBzZXR0aW5nc01hbmFnZXIuc2V0QXBpS2V5KCduZXcta2V5Jyk7XHJcbiAgICBcclxuICAgIGNvbnN0IHNldHRpbmdzID0gc2V0dGluZ3NNYW5hZ2VyLmdldFNldHRpbmdzKCk7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3MuYXBpS2V5KS50b0JlKCduZXcta2V5Jyk7XHJcbiAgICBleHBlY3Qoc2F2ZVNldHRpbmdzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGdldCBwcm92aWRlcicsICgpID0+IHtcclxuICAgIGV4cGVjdChzZXR0aW5nc01hbmFnZXIuZ2V0UHJvdmlkZXIoKSkudG9CZShERUZBVUxUX1NFVFRJTkdTLnByb3ZpZGVyKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgZ2V0IEFQSSBrZXknLCAoKSA9PiB7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3NNYW5hZ2VyLmdldEFwaUtleSgpKS50b0JlKERFRkFVTFRfU0VUVElOR1MuYXBpS2V5KTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgZ2V0IG1vZGVsJywgKCkgPT4ge1xyXG4gICAgZXhwZWN0KHNldHRpbmdzTWFuYWdlci5nZXRNb2RlbCgpKS50b0JlKERFRkFVTFRfU0VUVElOR1MubW9kZWwpO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBnZXQgY29udmVyc2F0aW9ucyBwYXRoJywgKCkgPT4ge1xyXG4gICAgZXhwZWN0KHNldHRpbmdzTWFuYWdlci5nZXRDb252ZXJzYXRpb25zUGF0aCgpKS50b0JlKERFRkFVTFRfU0VUVElOR1MuY29udmVyc2F0aW9uc0ZvbGRlcik7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGdldCBkZWZhdWx0IHN5c3RlbSBwcm9tcHQnLCAoKSA9PiB7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3NNYW5hZ2VyLmdldERlZmF1bHRTeXN0ZW1Qcm9tcHQoKSkudG9CZShERUZBVUxUX1NFVFRJTkdTLmRlZmF1bHRTeXN0ZW1Qcm9tcHQpO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBjaGVjayBpZiBkZWJ1ZyBtb2RlIGlzIGVuYWJsZWQnLCAoKSA9PiB7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3NNYW5hZ2VyLmlzRGVidWdNb2RlRW5hYmxlZCgpKS50b0JlKERFRkFVTFRfU0VUVElOR1MuZGVidWdNb2RlKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgcmVzZXQgdG8gZGVmYXVsdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBGaXJzdCB1cGRhdGUgc29tZSBzZXR0aW5nc1xyXG4gICAgYXdhaXQgc2V0dGluZ3NNYW5hZ2VyLnVwZGF0ZVNldHRpbmdzKHtcclxuICAgICAgYXBpS2V5OiAndGVzdC1rZXknLFxyXG4gICAgICBtb2RlbDogJ3Rlc3QtbW9kZWwnXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgLy8gVGhlbiByZXNldCB0byBkZWZhdWx0c1xyXG4gICAgYXdhaXQgc2V0dGluZ3NNYW5hZ2VyLnJlc2V0VG9EZWZhdWx0cygpO1xyXG4gICAgXHJcbiAgICBjb25zdCBzZXR0aW5ncyA9IHNldHRpbmdzTWFuYWdlci5nZXRTZXR0aW5ncygpO1xyXG4gICAgZXhwZWN0KHNldHRpbmdzKS50b0VxdWFsKERFRkFVTFRfU0VUVElOR1MpO1xyXG4gIH0pO1xyXG59KTtcclxuXHJcbmRlc2NyaWJlKCdTZXR0aW5nc0V4cG9ydEltcG9ydCcsICgpID0+IHtcclxuICBsZXQgZXZlbnRCdXM6IEV2ZW50QnVzO1xyXG4gIGxldCBzYXZlU2V0dGluZ3M6IGplc3QuTW9jaztcclxuICBsZXQgc2V0dGluZ3NNYW5hZ2VyOiBTZXR0aW5nc01hbmFnZXI7XHJcbiAgbGV0IGV4cG9ydEltcG9ydDogU2V0dGluZ3NFeHBvcnRJbXBvcnQ7XHJcbiAgXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBldmVudEJ1cyA9IG5ldyBFdmVudEJ1cygpO1xyXG4gICAgc2F2ZVNldHRpbmdzID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcbiAgICBzZXR0aW5nc01hbmFnZXIgPSBuZXcgU2V0dGluZ3NNYW5hZ2VyKFxyXG4gICAgICB7IC4uLkRFRkFVTFRfU0VUVElOR1MsIGFwaUtleTogJ3Rlc3Qta2V5JyB9LFxyXG4gICAgICBzYXZlU2V0dGluZ3MsXHJcbiAgICAgIGV2ZW50QnVzXHJcbiAgICApO1xyXG4gICAgZXhwb3J0SW1wb3J0ID0gbmV3IFNldHRpbmdzRXhwb3J0SW1wb3J0KHNldHRpbmdzTWFuYWdlcik7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGV4cG9ydCBzZXR0aW5ncyB0byBKU09OIHdpdGhvdXQgQVBJIGtleScsICgpID0+IHtcclxuICAgIGNvbnN0IGpzb24gPSBleHBvcnRJbXBvcnQuZXhwb3J0VG9Kc29uKGZhbHNlKTtcclxuICAgIGNvbnN0IGV4cG9ydGVkID0gSlNPTi5wYXJzZShqc29uKTtcclxuICAgIFxyXG4gICAgZXhwZWN0KGV4cG9ydGVkKS50b0VxdWFsKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgLi4uREVGQVVMVF9TRVRUSU5HUyxcclxuICAgICAgYXBpS2V5OiAnJyAvLyBBUEkga2V5IHNob3VsZCBiZSByZW1vdmVkXHJcbiAgICB9KSk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGV4cG9ydCBzZXR0aW5ncyB0byBKU09OIHdpdGggQVBJIGtleScsICgpID0+IHtcclxuICAgIGNvbnN0IGpzb24gPSBleHBvcnRJbXBvcnQuZXhwb3J0VG9Kc29uKHRydWUpO1xyXG4gICAgY29uc3QgZXhwb3J0ZWQgPSBKU09OLnBhcnNlKGpzb24pO1xyXG4gICAgXHJcbiAgICBleHBlY3QoZXhwb3J0ZWQpLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAuLi5ERUZBVUxUX1NFVFRJTkdTLFxyXG4gICAgICBhcGlLZXk6ICd0ZXN0LWtleScgLy8gQVBJIGtleSBzaG91bGQgYmUgaW5jbHVkZWRcclxuICAgIH0pKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgaW1wb3J0IHNldHRpbmdzIGZyb20gSlNPTicsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGltcG9ydEpzb24gPSBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIHByb3ZpZGVyOiAnb3BlbmFpJyxcclxuICAgICAgbW9kZWw6ICdncHQtNCcsXHJcbiAgICAgIGRlYnVnTW9kZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGF3YWl0IGV4cG9ydEltcG9ydC5pbXBvcnRGcm9tSnNvbihpbXBvcnRKc29uKTtcclxuICAgIFxyXG4gICAgY29uc3Qgc2V0dGluZ3MgPSBzZXR0aW5nc01hbmFnZXIuZ2V0U2V0dGluZ3MoKTtcclxuICAgIGV4cGVjdChzZXR0aW5ncy5wcm92aWRlcikudG9CZSgnb3BlbmFpJyk7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3MubW9kZWwpLnRvQmUoJ2dwdC00Jyk7XHJcbiAgICBleHBlY3Qoc2V0dGluZ3MuZGVidWdNb2RlKS50b0JlKHRydWUpO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCB0aHJvdyBlcnJvciBvbiBpbnZhbGlkIEpTT04nLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBleHBlY3QoZXhwb3J0SW1wb3J0LmltcG9ydEZyb21Kc29uKCdpbnZhbGlkIGpzb24nKSkucmVqZWN0cy50b1Rocm93KCk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIHRocm93IGVycm9yIG9uIGludmFsaWQgc2V0dGluZ3MgZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgYXdhaXQgZXhwZWN0KGV4cG9ydEltcG9ydC5pbXBvcnRGcm9tSnNvbignXCJub3QgYW4gb2JqZWN0XCInKSkucmVqZWN0cy50b1Rocm93KCk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXX0=