import { EventBus } from '../../src/core/EventBus';
describe('EventBus', () => {
    let eventBus;
    beforeEach(() => {
        eventBus = new EventBus();
    });
    test('should register and trigger event handlers', () => {
        const handler = jest.fn();
        eventBus.on('test', handler);
        eventBus.emit('test', { data: 'test' });
        expect(handler).toHaveBeenCalledWith({ data: 'test' });
    });
    test('should unregister event handlers', () => {
        const handler = jest.fn();
        eventBus.on('test', handler);
        eventBus.off('test', handler);
        eventBus.emit('test', { data: 'test' });
        expect(handler).not.toHaveBeenCalled();
    });
    test('should handle multiple handlers for the same event', () => {
        const handler1 = jest.fn();
        const handler2 = jest.fn();
        eventBus.on('test', handler1);
        eventBus.on('test', handler2);
        eventBus.emit('test', { data: 'test' });
        expect(handler1).toHaveBeenCalledWith({ data: 'test' });
        expect(handler2).toHaveBeenCalledWith({ data: 'test' });
    });
    test('should handle errors in event handlers', () => {
        const errorHandler = jest.fn().mockImplementation(() => {
            throw new Error('Test error');
        });
        const handler = jest.fn();
        // Mock console.error to track calls
        const originalConsoleError = console.error;
        const mockConsoleError = jest.fn();
        console.error = mockConsoleError;
        try {
            eventBus.on('test', errorHandler);
            eventBus.on('test', handler);
            eventBus.emit('test', { data: 'test' });
            // First handler threw an error but second was still called
            expect(errorHandler).toHaveBeenCalledWith({ data: 'test' });
            expect(handler).toHaveBeenCalledWith({ data: 'test' });
            expect(mockConsoleError).toHaveBeenCalled();
        }
        finally {
            // Restore console.error
            console.error = originalConsoleError;
        }
    });
    test('should handle async event handlers', async () => {
        const asyncHandler = jest.fn().mockImplementation(async () => {
            await new Promise(resolve => setTimeout(resolve, 10));
            return 'done';
        });
        eventBus.on('test', asyncHandler);
        eventBus.emit('test', { data: 'test' });
        // Handler was called but we didn't wait for it
        expect(asyncHandler).toHaveBeenCalledWith({ data: 'test' });
    });
    test('should wait for async event handlers with emitAsync', async () => {
        const results = [];
        const asyncHandler1 = jest.fn().mockImplementation(async () => {
            await new Promise(resolve => setTimeout(resolve, 10));
            results.push('handler1');
        });
        const asyncHandler2 = jest.fn().mockImplementation(async () => {
            await new Promise(resolve => setTimeout(resolve, 5));
            results.push('handler2');
        });
        eventBus.on('test', asyncHandler1);
        eventBus.on('test', asyncHandler2);
        await eventBus.emitAsync('test', { data: 'test' });
        // Both handlers were called and completed
        expect(asyncHandler1).toHaveBeenCalledWith({ data: 'test' });
        expect(asyncHandler2).toHaveBeenCalledWith({ data: 'test' });
        expect(results).toContain('handler1');
        expect(results).toContain('handler2');
    });
    test('should handle errors in async event handlers', async () => {
        const asyncErrorHandler = jest.fn().mockImplementation(async () => {
            await new Promise(resolve => setTimeout(resolve, 5));
            throw new Error('Async test error');
        });
        const asyncHandler = jest.fn().mockImplementation(async () => {
            await new Promise(resolve => setTimeout(resolve, 5));
            return 'done';
        });
        // Mock console.error to track calls
        const originalConsoleError = console.error;
        const mockConsoleError = jest.fn();
        console.error = mockConsoleError;
        try {
            eventBus.on('test', asyncErrorHandler);
            eventBus.on('test', asyncHandler);
            await eventBus.emitAsync('test', { data: 'test' });
            // Both handlers were called
            expect(asyncErrorHandler).toHaveBeenCalledWith({ data: 'test' });
            expect(asyncHandler).toHaveBeenCalledWith({ data: 'test' });
            expect(mockConsoleError).toHaveBeenCalled();
        }
        finally {
            // Restore console.error
            console.error = originalConsoleError;
        }
    });
    test('should clear all event handlers', () => {
        const handler1 = jest.fn();
        const handler2 = jest.fn();
        eventBus.on('test1', handler1);
        eventBus.on('test2', handler2);
        eventBus.clear();
        eventBus.emit('test1');
        eventBus.emit('test2');
        expect(handler1).not.toHaveBeenCalled();
        expect(handler2).not.toHaveBeenCalled();
    });
    test('should get a list of events with listeners', () => {
        eventBus.on('test1', () => { });
        eventBus.on('test2', () => { });
        const events = eventBus.getEvents();
        expect(events).toHaveLength(2);
        expect(events).toContain('test1');
        expect(events).toContain('test2');
    });
    test('should check if an event has listeners', () => {
        eventBus.on('test', () => { });
        expect(eventBus.hasListeners('test')).toBe(true);
        expect(eventBus.hasListeners('other')).toBe(false);
    });
    test('should get the number of listeners for an event', () => {
        eventBus.on('test', () => { });
        eventBus.on('test', () => { });
        expect(eventBus.listenerCount('test')).toBe(2);
        expect(eventBus.listenerCount('other')).toBe(0);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdXMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkV2ZW50QnVzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRW5ELFFBQVEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO0lBQ3hCLElBQUksUUFBa0IsQ0FBQztJQUV2QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsUUFBUSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsNENBQTRDLEVBQUUsR0FBRyxFQUFFO1FBQ3RELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUUxQixRQUFRLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM3QixRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRTtRQUM1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFFMUIsUUFBUSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDN0IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUIsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUV4QyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixF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LENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRCdXMgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9FdmVudEJ1cyc7XHJcblxyXG5kZXNjcmliZSgnRXZlbnRCdXMnLCAoKSA9PiB7XHJcbiAgbGV0IGV2ZW50QnVzOiBFdmVudEJ1cztcclxuICBcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGV2ZW50QnVzID0gbmV3IEV2ZW50QnVzKCk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIHJlZ2lzdGVyIGFuZCB0cmlnZ2VyIGV2ZW50IGhhbmRsZXJzJywgKCkgPT4ge1xyXG4gICAgY29uc3QgaGFuZGxlciA9IGplc3QuZm4oKTtcclxuICAgIFxyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBoYW5kbGVyKTtcclxuICAgIGV2ZW50QnVzLmVtaXQoJ3Rlc3QnLCB7IGRhdGE6ICd0ZXN0JyB9KTtcclxuICAgIFxyXG4gICAgZXhwZWN0KGhhbmRsZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCB1bnJlZ2lzdGVyIGV2ZW50IGhhbmRsZXJzJywgKCkgPT4ge1xyXG4gICAgY29uc3QgaGFuZGxlciA9IGplc3QuZm4oKTtcclxuICAgIFxyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBoYW5kbGVyKTtcclxuICAgIGV2ZW50QnVzLm9mZigndGVzdCcsIGhhbmRsZXIpO1xyXG4gICAgZXZlbnRCdXMuZW1pdCgndGVzdCcsIHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgXHJcbiAgICBleHBlY3QoaGFuZGxlcikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgaGFuZGxlIG11bHRpcGxlIGhhbmRsZXJzIGZvciB0aGUgc2FtZSBldmVudCcsICgpID0+IHtcclxuICAgIGNvbnN0IGhhbmRsZXIxID0gamVzdC5mbigpO1xyXG4gICAgY29uc3QgaGFuZGxlcjIgPSBqZXN0LmZuKCk7XHJcbiAgICBcclxuICAgIGV2ZW50QnVzLm9uKCd0ZXN0JywgaGFuZGxlcjEpO1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBoYW5kbGVyMik7XHJcbiAgICBldmVudEJ1cy5lbWl0KCd0ZXN0JywgeyBkYXRhOiAndGVzdCcgfSk7XHJcbiAgICBcclxuICAgIGV4cGVjdChoYW5kbGVyMSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBkYXRhOiAndGVzdCcgfSk7XHJcbiAgICBleHBlY3QoaGFuZGxlcjIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBoYW5kbGUgZXJyb3JzIGluIGV2ZW50IGhhbmRsZXJzJywgKCkgPT4ge1xyXG4gICAgY29uc3QgZXJyb3JIYW5kbGVyID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGVzdCBlcnJvcicpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBoYW5kbGVyID0gamVzdC5mbigpO1xyXG4gICAgXHJcbiAgICAvLyBNb2NrIGNvbnNvbGUuZXJyb3IgdG8gdHJhY2sgY2FsbHNcclxuICAgIGNvbnN0IG9yaWdpbmFsQ29uc29sZUVycm9yID0gY29uc29sZS5lcnJvcjtcclxuICAgIGNvbnN0IG1vY2tDb25zb2xlRXJyb3IgPSBqZXN0LmZuKCk7XHJcbiAgICBjb25zb2xlLmVycm9yID0gbW9ja0NvbnNvbGVFcnJvcjtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBlcnJvckhhbmRsZXIpO1xyXG4gICAgICBldmVudEJ1cy5vbigndGVzdCcsIGhhbmRsZXIpO1xyXG4gICAgICBldmVudEJ1cy5lbWl0KCd0ZXN0JywgeyBkYXRhOiAndGVzdCcgfSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBGaXJzdCBoYW5kbGVyIHRocmV3IGFuIGVycm9yIGJ1dCBzZWNvbmQgd2FzIHN0aWxsIGNhbGxlZFxyXG4gICAgICBleHBlY3QoZXJyb3JIYW5kbGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGRhdGE6ICd0ZXN0JyB9KTtcclxuICAgICAgZXhwZWN0KGhhbmRsZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgICBleHBlY3QobW9ja0NvbnNvbGVFcnJvcikudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgLy8gUmVzdG9yZSBjb25zb2xlLmVycm9yXHJcbiAgICAgIGNvbnNvbGUuZXJyb3IgPSBvcmlnaW5hbENvbnNvbGVFcnJvcjtcclxuICAgIH1cclxuICB9KTtcclxuICBcclxuICB0ZXN0KCdzaG91bGQgaGFuZGxlIGFzeW5jIGV2ZW50IGhhbmRsZXJzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgYXN5bmNIYW5kbGVyID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMCkpO1xyXG4gICAgICByZXR1cm4gJ2RvbmUnO1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGV2ZW50QnVzLm9uKCd0ZXN0JywgYXN5bmNIYW5kbGVyKTtcclxuICAgIGV2ZW50QnVzLmVtaXQoJ3Rlc3QnLCB7IGRhdGE6ICd0ZXN0JyB9KTtcclxuICAgIFxyXG4gICAgLy8gSGFuZGxlciB3YXMgY2FsbGVkIGJ1dCB3ZSBkaWRuJ3Qgd2FpdCBmb3IgaXRcclxuICAgIGV4cGVjdChhc3luY0hhbmRsZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCB3YWl0IGZvciBhc3luYyBldmVudCBoYW5kbGVycyB3aXRoIGVtaXRBc3luYycsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3VsdHM6IHN0cmluZ1tdID0gW107XHJcbiAgICBcclxuICAgIGNvbnN0IGFzeW5jSGFuZGxlcjEgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwKSk7XHJcbiAgICAgIHJlc3VsdHMucHVzaCgnaGFuZGxlcjEnKTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBjb25zdCBhc3luY0hhbmRsZXIyID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1KSk7XHJcbiAgICAgIHJlc3VsdHMucHVzaCgnaGFuZGxlcjInKTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBldmVudEJ1cy5vbigndGVzdCcsIGFzeW5jSGFuZGxlcjEpO1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBhc3luY0hhbmRsZXIyKTtcclxuICAgIFxyXG4gICAgYXdhaXQgZXZlbnRCdXMuZW1pdEFzeW5jKCd0ZXN0JywgeyBkYXRhOiAndGVzdCcgfSk7XHJcbiAgICBcclxuICAgIC8vIEJvdGggaGFuZGxlcnMgd2VyZSBjYWxsZWQgYW5kIGNvbXBsZXRlZFxyXG4gICAgZXhwZWN0KGFzeW5jSGFuZGxlcjEpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgZXhwZWN0KGFzeW5jSGFuZGxlcjIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgZXhwZWN0KHJlc3VsdHMpLnRvQ29udGFpbignaGFuZGxlcjEnKTtcclxuICAgIGV4cGVjdChyZXN1bHRzKS50b0NvbnRhaW4oJ2hhbmRsZXIyJyk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGhhbmRsZSBlcnJvcnMgaW4gYXN5bmMgZXZlbnQgaGFuZGxlcnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBhc3luY0Vycm9ySGFuZGxlciA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4ge1xyXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNSkpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FzeW5jIHRlc3QgZXJyb3InKTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBjb25zdCBhc3luY0hhbmRsZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUpKTtcclxuICAgICAgcmV0dXJuICdkb25lJztcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICAvLyBNb2NrIGNvbnNvbGUuZXJyb3IgdG8gdHJhY2sgY2FsbHNcclxuICAgIGNvbnN0IG9yaWdpbmFsQ29uc29sZUVycm9yID0gY29uc29sZS5lcnJvcjtcclxuICAgIGNvbnN0IG1vY2tDb25zb2xlRXJyb3IgPSBqZXN0LmZuKCk7XHJcbiAgICBjb25zb2xlLmVycm9yID0gbW9ja0NvbnNvbGVFcnJvcjtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgZXZlbnRCdXMub24oJ3Rlc3QnLCBhc3luY0Vycm9ySGFuZGxlcik7XHJcbiAgICAgIGV2ZW50QnVzLm9uKCd0ZXN0JywgYXN5bmNIYW5kbGVyKTtcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGV2ZW50QnVzLmVtaXRBc3luYygndGVzdCcsIHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgICBcclxuICAgICAgLy8gQm90aCBoYW5kbGVycyB3ZXJlIGNhbGxlZFxyXG4gICAgICBleHBlY3QoYXN5bmNFcnJvckhhbmRsZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgZGF0YTogJ3Rlc3QnIH0pO1xyXG4gICAgICBleHBlY3QoYXN5bmNIYW5kbGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGRhdGE6ICd0ZXN0JyB9KTtcclxuICAgICAgZXhwZWN0KG1vY2tDb25zb2xlRXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIC8vIFJlc3RvcmUgY29uc29sZS5lcnJvclxyXG4gICAgICBjb25zb2xlLmVycm9yID0gb3JpZ2luYWxDb25zb2xlRXJyb3I7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGNsZWFyIGFsbCBldmVudCBoYW5kbGVycycsICgpID0+IHtcclxuICAgIGNvbnN0IGhhbmRsZXIxID0gamVzdC5mbigpO1xyXG4gICAgY29uc3QgaGFuZGxlcjIgPSBqZXN0LmZuKCk7XHJcbiAgICBcclxuICAgIGV2ZW50QnVzLm9uKCd0ZXN0MScsIGhhbmRsZXIxKTtcclxuICAgIGV2ZW50QnVzLm9uKCd0ZXN0MicsIGhhbmRsZXIyKTtcclxuICAgIGV2ZW50QnVzLmNsZWFyKCk7XHJcbiAgICBcclxuICAgIGV2ZW50QnVzLmVtaXQoJ3Rlc3QxJyk7XHJcbiAgICBldmVudEJ1cy5lbWl0KCd0ZXN0MicpO1xyXG4gICAgXHJcbiAgICBleHBlY3QoaGFuZGxlcjEpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICBleHBlY3QoaGFuZGxlcjIpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgfSk7XHJcbiAgXHJcbiAgdGVzdCgnc2hvdWxkIGdldCBhIGxpc3Qgb2YgZXZlbnRzIHdpdGggbGlzdGVuZXJzJywgKCkgPT4ge1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QxJywgKCkgPT4ge30pO1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QyJywgKCkgPT4ge30pO1xyXG4gICAgXHJcbiAgICBjb25zdCBldmVudHMgPSBldmVudEJ1cy5nZXRFdmVudHMoKTtcclxuICAgIFxyXG4gICAgZXhwZWN0KGV2ZW50cykudG9IYXZlTGVuZ3RoKDIpO1xyXG4gICAgZXhwZWN0KGV2ZW50cykudG9Db250YWluKCd0ZXN0MScpO1xyXG4gICAgZXhwZWN0KGV2ZW50cykudG9Db250YWluKCd0ZXN0MicpO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBjaGVjayBpZiBhbiBldmVudCBoYXMgbGlzdGVuZXJzJywgKCkgPT4ge1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCAoKSA9PiB7fSk7XHJcbiAgICBcclxuICAgIGV4cGVjdChldmVudEJ1cy5oYXNMaXN0ZW5lcnMoJ3Rlc3QnKSkudG9CZSh0cnVlKTtcclxuICAgIGV4cGVjdChldmVudEJ1cy5oYXNMaXN0ZW5lcnMoJ290aGVyJykpLnRvQmUoZmFsc2UpO1xyXG4gIH0pO1xyXG4gIFxyXG4gIHRlc3QoJ3Nob3VsZCBnZXQgdGhlIG51bWJlciBvZiBsaXN0ZW5lcnMgZm9yIGFuIGV2ZW50JywgKCkgPT4ge1xyXG4gICAgZXZlbnRCdXMub24oJ3Rlc3QnLCAoKSA9PiB7fSk7XHJcbiAgICBldmVudEJ1cy5vbigndGVzdCcsICgpID0+IHt9KTtcclxuICAgIFxyXG4gICAgZXhwZWN0KGV2ZW50QnVzLmxpc3RlbmVyQ291bnQoJ3Rlc3QnKSkudG9CZSgyKTtcclxuICAgIGV4cGVjdChldmVudEJ1cy5saXN0ZW5lckNvdW50KCdvdGhlcicpKS50b0JlKDApO1xyXG4gIH0pO1xyXG59KTtcclxuIl19